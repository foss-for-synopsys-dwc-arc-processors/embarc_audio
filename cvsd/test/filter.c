/*
* Copyright 2019, Synopsys, Inc.
* All rights reserved.
*
* This source code is licensed under the BSD-3-Clause license found in
* the LICENSE file in the root directory of this source tree.
*
*/

#include "filter.h"

#include "assert.h"
#include "math.h"
#include "stdio.h"
#include "stdlib.h"
#include "string.h"

#define FRACT_BITS 16
#define GAIN_FRACT_BITS 3 // With that gain, we have an amplitude of a signal almost the same like on input
#define FLDBL2FXDBL(val) ((int)(val * (1 << FRACT_BITS) + 0.5))
//Filter was generated according to frequency mask pointed in 
//Bluetooth Core Specification v5.0 of paragraph "A.7 FREQUENCY MASK"
/************** Output of generated FIL least-squares Lowpass filter *********/
// %
// % Generated by MATLAB(R) 8.0 and the Signal Processing Toolbox 6.18.
// %
// % Generated on: 05-Sep-2019 15:52:22
// %

// % Coefficient Format: Decimal

// % Discrete-Time FIR Filter (real)
// % -------------------------------
// % Filter Structure  : Direct-Form FIR
// % Filter Length     : 64
// % Stable            : Yes
// % Linear Phase      : Yes (Type 2)

// % FIR least-squares Lowpass filter designed using the FIRLS function.

// % All frequency values are in Hz.
// Fs = 64000;  % Sampling Frequency

// N     = 63;    % Order
// Fpass = 3400;  % Passband Frequency
// Fstop = 4000;  % Stopband Frequency
// Wpass = 1;     % Passband Weight
// Wstop = 1;     % Stopband Weight
// % Coefficient Format: Decimal

// Numerator:
// -0.0067278966758293514
// -0.0078821388415984614
// -0.0080548530675017271
// -0.0071138967841291641
// -0.0050674532932339566
// -0.0020775530086476518
//  0.0015458794216189817
//  0.0053714276716090659
//  0.0088913977210467281
//  0.011581618490116323
//  0.012969385430966702
//  0.012701563339427787
//  0.010604243335599858
//  0.006725779984408548
//  0.0013565228856604352
// -0.0049790273433333969
// -0.011558820308443593
// -0.017526385871068331
// -0.021974940229550786
// -0.024044090574917784
// -0.023018804019540699
// -0.01841949247821914
// -0.010072537938208833
//  0.0018476669020723181
//  0.016811224604917401
//  0.033962177394358695
//  0.05218321586626963
//  0.070189985391998805
//  0.086645875420022542
//  0.10028568811194814
//  0.1100353612852307
//  0.11511512826221462
//  0.11511512826221462
//  0.1100353612852307
//  0.10028568811194814
//  0.086645875420022542
//  0.070189985391998805
//  0.05218321586626963
//  0.033962177394358695
//  0.016811224604917401
//  0.0018476669020723181
// -0.010072537938208833
// -0.01841949247821914
// -0.023018804019540699
// -0.024044090574917784
// -0.021974940229550786
// -0.017526385871068331
// -0.011558820308443593
// -0.0049790273433333969
//  0.0013565228856604352
//  0.006725779984408548
//  0.010604243335599858
//  0.012701563339427787
//  0.012969385430966702
//  0.011581618490116323
//  0.0088913977210467281
//  0.0053714276716090659
//  0.0015458794216189817
// -0.0020775530086476518
// -0.0050674532932339566
// -0.0071138967841291641
// -0.0080548530675017271
// -0.0078821388415984614
// -0.0067278966758293514

const int16_t direct_FIR_8kHz_on_64kHz_Fx[FIR_FILTER_LENGTH] = {
    FLDBL2FXDBL(-0.0067278966758293514), FLDBL2FXDBL(-0.0078821388415984614),
    FLDBL2FXDBL(-0.0080548530675017271), FLDBL2FXDBL(-0.0071138967841291641),
    FLDBL2FXDBL(-0.0050674532932339566), FLDBL2FXDBL(-0.0020775530086476518),
    FLDBL2FXDBL(0.0015458794216189817),  FLDBL2FXDBL(0.0053714276716090659),
    FLDBL2FXDBL(0.0088913977210467281),  FLDBL2FXDBL(0.011581618490116323),
    FLDBL2FXDBL(0.012969385430966702),   FLDBL2FXDBL(0.012701563339427787),
    FLDBL2FXDBL(0.010604243335599858),   FLDBL2FXDBL(0.006725779984408548),
    FLDBL2FXDBL(0.0013565228856604352),  FLDBL2FXDBL(-0.0049790273433333969),
    FLDBL2FXDBL(-0.011558820308443593),  FLDBL2FXDBL(-0.017526385871068331),
    FLDBL2FXDBL(-0.021974940229550786),  FLDBL2FXDBL(-0.024044090574917784),
    FLDBL2FXDBL(-0.023018804019540699),  FLDBL2FXDBL(-0.01841949247821914),
    FLDBL2FXDBL(-0.010072537938208833),  FLDBL2FXDBL(0.0018476669020723181),
    FLDBL2FXDBL(0.016811224604917401),   FLDBL2FXDBL(0.033962177394358695),
    FLDBL2FXDBL(0.05218321586626963),    FLDBL2FXDBL(0.070189985391998805),
    FLDBL2FXDBL(0.086645875420022542),   FLDBL2FXDBL(0.10028568811194814),
    FLDBL2FXDBL(0.1100353612852307),     FLDBL2FXDBL(0.11511512826221462),
    FLDBL2FXDBL(0.11511512826221462),    FLDBL2FXDBL(0.1100353612852307),
    FLDBL2FXDBL(0.10028568811194814),    FLDBL2FXDBL(0.086645875420022542),
    FLDBL2FXDBL(0.070189985391998805),   FLDBL2FXDBL(0.05218321586626963),
    FLDBL2FXDBL(0.033962177394358695),   FLDBL2FXDBL(0.016811224604917401),
    FLDBL2FXDBL(0.0018476669020723181),  FLDBL2FXDBL(-0.010072537938208833),
    FLDBL2FXDBL(-0.01841949247821914),   FLDBL2FXDBL(-0.023018804019540699),
    FLDBL2FXDBL(-0.024044090574917784),  FLDBL2FXDBL(-0.021974940229550786),
    FLDBL2FXDBL(-0.017526385871068331),  FLDBL2FXDBL(-0.011558820308443593),
    FLDBL2FXDBL(-0.0049790273433333969), FLDBL2FXDBL(0.0013565228856604352),
    FLDBL2FXDBL(0.006725779984408548),   FLDBL2FXDBL(0.010604243335599858),
    FLDBL2FXDBL(0.012701563339427787),   FLDBL2FXDBL(0.012969385430966702),
    FLDBL2FXDBL(0.011581618490116323),   FLDBL2FXDBL(0.0088913977210467281),
    FLDBL2FXDBL(0.0053714276716090659),  FLDBL2FXDBL(0.0015458794216189817),
    FLDBL2FXDBL(-0.0020775530086476518), FLDBL2FXDBL(-0.0050674532932339566),
    FLDBL2FXDBL(-0.0071138967841291641), FLDBL2FXDBL(-0.0080548530675017271),
    FLDBL2FXDBL(-0.0078821388415984614), FLDBL2FXDBL(-0.0067278966758293514)
};

const int16_t polyphase_FIR_8kHz_on_64kHz_Fx[FIR_FILTER_LENGTH] = {
    FLDBL2FXDBL(0.0053714276716090659),  FLDBL2FXDBL(-0.0049790273433333969),
    FLDBL2FXDBL(0.0018476669020723181),  FLDBL2FXDBL(0.11511512826221462),
    FLDBL2FXDBL(0.016811224604917401),   FLDBL2FXDBL(-0.011558820308443593),
    FLDBL2FXDBL(0.0088913977210467281),  FLDBL2FXDBL(-0.0067278966758293514),
    FLDBL2FXDBL(0.0015458794216189817),  FLDBL2FXDBL(0.0013565228856604352),
    FLDBL2FXDBL(-0.010072537938208833),  FLDBL2FXDBL(0.1100353612852307),
    FLDBL2FXDBL(0.033962177394358695),   FLDBL2FXDBL(-0.017526385871068331),
    FLDBL2FXDBL(0.011581618490116323),   FLDBL2FXDBL(-0.0078821388415984614),
    FLDBL2FXDBL(-0.0020775530086476518), FLDBL2FXDBL(0.006725779984408548),
    FLDBL2FXDBL(-0.01841949247821914),   FLDBL2FXDBL(0.10028568811194814),
    FLDBL2FXDBL(0.05218321586626963),    FLDBL2FXDBL(-0.021974940229550786),
    FLDBL2FXDBL(0.012969385430966702),   FLDBL2FXDBL(-0.0080548530675017271),
    FLDBL2FXDBL(-0.0050674532932339566), FLDBL2FXDBL(0.010604243335599858),
    FLDBL2FXDBL(-0.023018804019540699),  FLDBL2FXDBL(0.086645875420022542),
    FLDBL2FXDBL(0.070189985391998805),   FLDBL2FXDBL(-0.024044090574917784),
    FLDBL2FXDBL(0.012701563339427787),   FLDBL2FXDBL(-0.0071138967841291641),
    FLDBL2FXDBL(-0.0071138967841291641), FLDBL2FXDBL(0.012701563339427787),
    FLDBL2FXDBL(-0.024044090574917784),  FLDBL2FXDBL(0.070189985391998805),
    FLDBL2FXDBL(0.086645875420022542),   FLDBL2FXDBL(-0.023018804019540699),
    FLDBL2FXDBL(0.010604243335599858),   FLDBL2FXDBL(-0.0050674532932339566),
    FLDBL2FXDBL(-0.0080548530675017271), FLDBL2FXDBL(0.012969385430966702),
    FLDBL2FXDBL(-0.021974940229550786),  FLDBL2FXDBL(0.05218321586626963),
    FLDBL2FXDBL(0.10028568811194814),    FLDBL2FXDBL(-0.01841949247821914),
    FLDBL2FXDBL(0.006725779984408548),   FLDBL2FXDBL(-0.0020775530086476518),
    FLDBL2FXDBL(-0.0078821388415984614), FLDBL2FXDBL(0.011581618490116323),
    FLDBL2FXDBL(-0.017526385871068331),  FLDBL2FXDBL(0.033962177394358695),
    FLDBL2FXDBL(0.1100353612852307),     FLDBL2FXDBL(-0.010072537938208833),
    FLDBL2FXDBL(0.0013565228856604352),  FLDBL2FXDBL(0.0015458794216189817),
    FLDBL2FXDBL(-0.0067278966758293514), FLDBL2FXDBL(0.0088913977210467281),
    FLDBL2FXDBL(-0.011558820308443593),  FLDBL2FXDBL(0.016811224604917401),
    FLDBL2FXDBL(0.11511512826221462),    FLDBL2FXDBL(0.0018476669020723181),
    FLDBL2FXDBL(-0.0049790273433333969), FLDBL2FXDBL(0.0053714276716090659)
};

int interpolation_x8(int16_t *inp_buf, int inp_len, int16_t *out_buf,  int out_len){
    static const int L_factor = 8;

    for(int i = FIR_FILTER_LENGTH; i < inp_len; i++) {
        int16_t *p_fir = (int16_t *)polyphase_FIR_8kHz_on_64kHz_Fx;
        for(int k = 0; k < L_factor; k++) {
            int16_t *inp_buf_shift_left_fir_len = (int16_t *)(inp_buf - (L_factor - 1) + i);
            long long accum = inp_buf_shift_left_fir_len[0] * *p_fir++;
#pragma clang loop unroll(full)
            for(int j = 1; j < L_factor; j++) {
                accum += (long long)inp_buf_shift_left_fir_len[j] * *p_fir++;
            }
            *out_buf++ = accum >> (FRACT_BITS - GAIN_FRACT_BITS);
        }
    }
    return 0;
}

int decimation_x8(int16_t * inp_buf, int inp_len, int16_t * out_buf, int out_len) {
    static const int M_factor = 8;

    for( int i = FIR_FILTER_LENGTH; i < inp_len; i += M_factor) {
        int16_t *p_fir_filter = (int16_t *)direct_FIR_8kHz_on_64kHz_Fx;
        int16_t *inp_buf_shift_left_fir_len = (int16_t *)(inp_buf - FIR_FILTER_LENGTH + i);
        long long accum = 0;
#pragma clang loop unroll_count(2)
        for(int j = 0; j < FIR_FILTER_LENGTH; j++) {
            accum += (long long)inp_buf_shift_left_fir_len[j] * *p_fir_filter++;
        }
        *out_buf++ = accum >> FRACT_BITS;
    }

    return 0;
}